library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity Simple_TX_Test is
    Port (
        clk_50mhz : in std_logic;
        uart_tx   : out std_logic
    );
end Simple_TX_Test;

architecture Behavioral of Simple_TX_Test is
    -- Setting Baud Rate 9600 (50MHz / 9600 = 5208)
    constant c_CLKS_PER_BIT : integer := 5208;
    
    -- Counter untuk delay 1 detik (50.000.000 clock)
    constant c_DELAY_1SEC   : integer := 50000000;
    
    signal r_tx_pin : std_logic := '1';
    
    -- State Machine Sederhana
    type t_state is (IDLE, TX_START, TX_DATA, TX_STOP);
    signal state : t_state := IDLE;
    
    signal clk_cnt    : integer range 0 to c_CLKS_PER_BIT := 0;
    signal bit_idx    : integer range 0 to 7 := 0;
    signal tx_data    : std_logic_vector(7 downto 0) := x"41"; -- Huruf 'A'
    signal delay_cnt  : integer range 0 to c_DELAY_1SEC := 0;

begin
    uart_tx <= r_tx_pin;

    process(clk_50mhz)
    begin
        if rising_edge(clk_50mhz) then
            
            case state is
                -- 1. STATE IDLE: Tunggu 1 Detik, lalu mulai kirim
                when IDLE =>
                    r_tx_pin <= '1'; -- Line Idle harus High
                    clk_cnt <= 0;
                    bit_idx <= 0;
                    
                    if delay_cnt < c_DELAY_1SEC then
                        delay_cnt <= delay_cnt + 1;
                    else
                        delay_cnt <= 0;
                        state <= TX_START; -- Mulai kirim setelah 1 detik
                    end if;

                -- 2. STATE START BIT: Kirim Logic 0
                when TX_START =>
                    r_tx_pin <= '0'; -- Start Bit
                    if clk_cnt < c_CLKS_PER_BIT-1 then
                        clk_cnt <= clk_cnt + 1;
                    else
                        clk_cnt <= 0;
                        state <= TX_DATA;
                    end if;

                -- 3. STATE DATA BITS: Kirim 8 bit (LSB First)
                when TX_DATA =>
                    r_tx_pin <= tx_data(bit_idx); -- Kirim bit ke-idx
                    
                    if clk_cnt < c_CLKS_PER_BIT-1 then
                        clk_cnt <= clk_cnt + 1;
                    else
                        clk_cnt <= 0;
                        if bit_idx < 7 then
                            bit_idx <= bit_idx + 1;
                        else
                            bit_idx <= 0;
                            state <= TX_STOP;
                        end if;
                    end if;

                -- 4. STATE STOP BIT: Kirim Logic 1
                when TX_STOP =>
                    r_tx_pin <= '1'; -- Stop Bit
                    if clk_cnt < c_CLKS_PER_BIT-1 then
                        clk_cnt <= clk_cnt + 1;
                    else
                        clk_cnt <= 0;
                        state <= IDLE; -- Kembali tunggu 1 detik
                    end if;
            end case;
        end if;
    end process;
end Behavioral;